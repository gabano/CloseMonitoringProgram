<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação Acadêmica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background-color: #f8f9fa; font-family: sans-serif; }
        .card { border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-subject { height: 60px; font-weight: bold; }
        .step-hidden { display: none; }
        .likert-btn { width: 30%; height: 50px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="card p-4">
        
        <div id="step-1">
            <h4 class="text-center mb-3">Escaneie o QR Code do Aluno</h4>
            <div id="reader" style="width: 100%; border-radius: 10px; overflow: hidden;"></div>
            <div class="mt-3">
                <label class="form-label">Selecionar Câmera:</label>
                <select id="camera-select" class="form-select"></select>
            </div>
        </div>

        <div id="step-2" class="step-hidden">
            <h4 class="text-center mb-4">Selecione a Disciplina</h4>
            <div class="row g-2" id="subject-grid">
                </div>
        </div>

        <div id="step-3" class="step-hidden">
            <h5 id="display-info" class="text-muted small mb-3"></h5>
            
            <form id="eval-form">
                <div class="mb-4">
                    <label class="form-label fw-bold">1. Tarefas de casa cumpridas?</label>
                    <div class="d-flex justify-content-between">
                        <input type="radio" class="btn-check" name="q1" id="q1-0" value="0"><label class="btn btn-outline-danger likert-btn" for="q1-0">0<br><small>Nenhuma</small></label>
                        <input type="radio" class="btn-check" name="q1" id="q1-3" value="3"><label class="btn btn-outline-warning likert-btn" for="q1-3">3<br><small>Algumas</small></label>
                        <input type="radio" class="btn-check" name="q1" id="q1-5" value="5"><label class="btn btn-outline-success likert-btn" for="q1-5">5<br><small>Todas</small></label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">2. Conversa / Distração em sala?</label>
                    <div class="d-flex justify-content-between">
                        <input type="radio" class="btn-check" name="q2" id="q2-0" value="0"><label class="btn btn-outline-success likert-btn" for="q2-0">0<br><small>Nunca</small></label>
                        <input type="radio" class="btn-check" name="q2" id="q2-3" value="3"><label class="btn btn-outline-warning likert-btn" for="q2-3">3<br><small>Às vezes</small></label>
                        <input type="radio" class="btn-check" name="q2" id="q2-5" value="5"><label class="btn btn-outline-danger likert-btn" for="q2-5">5<br><small>Sempre</small></label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">3. Domínio da disciplina?</label>
                    <div class="d-flex justify-content-between">
                        <input type="radio" class="btn-check" name="q3" id="q3-0" value="0"><label class="btn btn-outline-danger likert-btn" for="q3-0">0<br><small>Nenhum</small></label>
                        <input type="radio" class="btn-check" name="q3" id="q3-3" value="3"><label class="btn btn-outline-warning likert-btn" for="q3-3">3<br><small>Regular</small></label>
                        <input type="radio" class="btn-check" name="q3" id="q3-5" value="5"><label class="btn btn-outline-success likert-btn" for="q3-5">5<br><small>Total</small></label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">4. Para melhorar o aluno deve:</label>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Conversa"> Diminuir conversa</div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Rever conteúdos"> Rever conteúdos em casa</div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Organização"> Trabalhar organização</div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Entregas"> Focar nas entregas passadas</div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" value="Prazo"> Entregar atividades no prazo</div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">5. Observações (Opcional):</label>
                    <textarea class="form-control" id="q5-obs" rows="3" placeholder="Escreva aqui..."></textarea>
                </div>

                <button type="button" onclick="submitData()" class="btn btn-primary w-100 btn-lg">Finalizar e Voltar</button>
            </form>
        </div>

    </div>
</div>

<script>
// --- CONFIGURATION ---
const subjects = ['ELA', 'SCI', 'MATH', 'PORT', 'GEO', 'HIS', 'PE', 'MAT.AP', 'ART'];
let formData = { studentId: '', subject: '' };
let html5QrCode;

// --- INITIALIZE SUBJECTS ---
const grid = document.getElementById('subject-grid');
subjects.forEach(s => {
    grid.innerHTML += `<div class="col-4"><button class="btn btn-outline-secondary w-100 btn-subject" onclick="selectSubject('${s}')">${s}</button></div>`;
});

// --- CAMERA LOGIC ---
Html5Qrcode.getCameras().then(devices => {
    const select = document.getElementById('camera-select');
    devices.forEach((device, index) => {
        const opt = document.createElement('option');
        opt.value = device.id;
        opt.text = device.label || `Camera ${index}`;
        // Set preference for Back Camera
        if (device.label.toLowerCase().includes('back')) opt.selected = true;
        select.appendChild(opt);
    });
    startScanner(select.value);
    select.onchange = () => { html5QrCode.stop().then(() => startScanner(select.value)); };
});

function startScanner(cameraId) {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, (decodedText) => {
        formData.studentId = decodedText;
        nextStep(2);
        html5QrCode.stop();
    });
}

// --- NAVIGATION ---
function nextStep(step) {
    document.getElementById('step-1').classList.add('step-hidden');
    document.getElementById('step-2').classList.add('step-hidden');
    document.getElementById('step-3').classList.add('step-hidden');
    document.getElementById(`step-${step}`).classList.remove('step-hidden');
}

function selectSubject(s) {
    formData.subject = s;
    document.getElementById('display-info').innerText = `Aluno: ${formData.studentId} | Matéria: ${s}`;
    nextStep(3);
}

// --- SUBMIT TO GOOGLE SHEETS ---
async function submitData() {
    const q4Checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
    
    const payload = {
        ...formData,
        q1: document.querySelector('input[name="q1"]:checked')?.value || 0,
        q2: document.querySelector('input[name="q2"]:checked')?.value || 0,
        q3: document.querySelector('input[name="q3"]:checked')?.value || 0,
        q4: q4Checked.join(', '),
        q5: document.getElementById('q5-obs').value
    };

    console.log("Sending Data:", payload);
    // Replace URL below with your Google Apps Script Web App URL
    // await fetch('YOUR_APPS_SCRIPT_URL', { method: 'POST', body: JSON.stringify(payload) });

    alert("Avaliação enviada com sucesso!");
    location.reload(); // Returns to start
}
</script>
</body>
</html>
