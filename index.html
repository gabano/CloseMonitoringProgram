<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avaliação Escolar</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 480px; background: var(--card); padding: 20px; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        h2 { text-align: center; font-size: 1.2rem; margin-bottom: 20px; color: var(--primary); }
        .section { display: none; }
        .active { display: block; animation: slideUp 0.3s ease-out; }
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: #000; }
        .camera-controls { margin-top: 10px; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; background: white; font-size: 16px; }
        
        .subject-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
        .subject-card { padding: 12px 4px; text-align: center; border: 1px solid #cbd5e1; border-radius: 10px; cursor: pointer; font-size: 0.75rem; font-weight: bold; transition: 0.2s; }
        .subject-card.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .likert-title { font-weight: bold; margin: 15px 0 8px; display: block; font-size: 0.9rem; }
        .likert-scale { display: flex; justify-content: space-between; background: #f8fafc; padding: 8px; border-radius: 50px; border: 1px solid #e2e8f0; }
        .likert-btn { width: 38px; height: 38px; border-radius: 50%; border: 1px solid #cbd5e1; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .likert-btn { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 0 10px rgba(37,99,235,0.3); }

        .check-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .check-item { background: #f8fafc; padding: 10px; border-radius: 8px; font-size: 0.8rem; display: flex; align-items: center; border: 1px solid #e2e8f0; }
        .check-item input { margin-right: 8px; transform: scale(1.2); }

        textarea { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; margin-top: 8px; font-size: 16px; }
        button#submitBtn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; margin-top: 20px; box-shadow: 0 4px 6px -1px rgba(37,99,235,0.4); }
        button:disabled { background: #94a3b8; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>Avaliação de Desempenho</h2>

    <div id="step-qr" class="section active">
        <div id="reader"></div>
        <div class="camera-controls">
            <select id="cameraSelect"><option value="">Detectando câmeras...</option></select>
        </div>
        <p style="text-align:center; color: #64748b; font-size: 0.9rem; margin-top: 15px;">Aponte para o QR Code do Aluno</p>
    </div>

    <div id="step-form" class="section">
        <form id="evalForm">
            <input type="hidden" id="QRID" name="QRID">
            
            <span class="likert-title">Disciplina:</span>
            <div class="subject-grid">
                <div class="subject-card" onclick="selectSub(this, 'ELA')">ELA</div>
                <div class="subject-card" onclick="selectSub(this, 'MAT')">MAT</div>
                <div class="subject-card" onclick="selectSub(this, 'SCI')">SCI</div>
                <div class="subject-card" onclick="selectSub(this, 'GEO')">GEO</div>
                <div class="subject-card" onclick="selectSub(this, 'HIS')">HIS</div>
                <div class="subject-card" onclick="selectSub(this, 'POR')">POR</div>
                <div class="subject-card" onclick="selectSub(this, 'ART')">ART</div>
                <div class="subject-card" onclick="selectSub(this, 'PE')">PE</div>
                <div class="subject-card" onclick="selectSub(this, 'MAT.APLICADA')">M.APL</div>
            </div>
            <input type="hidden" name="subject" id="selectedSubject" required>

            <span class="likert-title">Q1. Realizou tarefas do período?</span>
            <div class="likert-scale">
                <label><input type="radio" name="q1" value="0" required><div class="likert-btn">0</div></label>
                <label><input type="radio" name="q1" value="1"><div class="likert-btn">1</div></label>
                <label><input type="radio" name="q1" value="2"><div class="likert-btn">2</div></label>
                <label><input type="radio" name="q1" value="3"><div class="likert-btn">3</div></label>
                <label><input type="radio" name="q1" value="4"><div class="likert-btn">4</div></label>
                <label><input type="radio" name="q1" value="5"><div class="likert-btn">5</div></label>
            </div>

            <span class="likert-title">Q2. Engajamento em sala?</span>
            <div class="likert-scale">
                <label><input type="radio" name="q2" value="0" required><div class="likert-btn">0</div></label>
                <label><input type="radio" name="q2" value="1"><div class="likert-btn">1</div></label>
                <label><input type="radio" name="q2" value="2"><div class="likert-btn">2</div></label>
                <label><input type="radio" name="q2" value="3"><div class="likert-btn">3</div></label>
                <label><input type="radio" name="q2" value="4"><div class="likert-btn">4</div></label>
                <label><input type="radio" name="q2" value="5"><div class="likert-btn">5</div></label>
            </div>

            <span class="likert-title">Q3. Organização material/caderno?</span>
            <div class="likert-scale">
                <label><input type="radio" name="q3" value="0" required><div class="likert-btn">0</div></label>
                <label><input type="radio" name="q3" value="1"><div class="likert-btn">1</div></label>
                <label><input type="radio" name="q3" value="2"><div class="likert-btn">2</div></label>
                <label><input type="radio" name="q3" value="3"><div class="likert-btn">3</div></label>
                <label><input type="radio" name="q3" value="4"><div class="likert-btn">4</div></label>
                <label><input type="radio" name="q3" value="5"><div class="likert-btn">5</div></label>
            </div>

            <span class="likert-title">Q4. Precisa melhorar:</span>
            <div class="check-grid">
                <label class="check-item"><input type="checkbox" name="improve" value="Pontualidade"> Pontualidade</label>
                <label class="check-item"><input type="checkbox" name="improve" value="Organização"> Organização</label>
                <label class="check-item"><input type="checkbox" name="improve" value="Foco"> Foco</label>
                <label class="check-item"><input type="checkbox" name="improve" value="Participação"> Participação</label>
                <label class="check-item"><input type="checkbox" name="improve" value="Revisão"> Revisão</label>
                <label class="check-item"><input type="checkbox" name="improve" value="Interpretação"> Interpretação</label>
            </div>

            <span class="likert-title">Q5. Observações:</span>
            <textarea name="observations" placeholder="Opcional..."></textarea>

            <button type="submit" id="submitBtn">Finalizar Avaliação</button>
        </form>
    </div>
</div>

<script>
    const WEBHOOK_URL = 'https://n8n.srv1303523.hstgr.cloud/webhook/87110564-68b0-4510-834d-aada99d853e5';
    let html5QrCode;

    // Inicializa Câmeras
    async function initScanner() {
        try {
            const devices = await Html5Qrcode.getCameras();
            const select = document.getElementById('cameraSelect');
            select.innerHTML = "";
            
            devices.forEach((device, index) => {
                const opt = document.createElement('option');
                opt.value = device.id;
                opt.text = device.label || `Câmera ${index + 1}`;
                select.appendChild(opt);
            });

            // Forçar Traseira (Back)
            const back = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('traseira'));
            const startId = back ? back.id : devices[0].id;
            select.value = startId;
            
            html5QrCode = new Html5Qrcode("reader");
            startScan(startId);
        } catch (e) { alert("Erro ao acessar câmera: " + e); }
    }

    function startScan(id) {
        html5QrCode.start(id, { fps: 10, qrbox: 250 }, (text) => {
            document.getElementById('QRID').value = text;
            html5QrCode.stop().then(() => {
                document.getElementById('step-qr').classList.remove('active');
                document.getElementById('step-form').classList.add('active');
                window.scrollTo(0,0);
            });
        });
    }

    document.getElementById('cameraSelect').onchange = (e) => {
        html5QrCode.stop().then(() => startScan(e.target.value));
    };

    function selectSub(el, val) {
        document.querySelectorAll('.subject-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('selectedSubject').value = val;
    }

    // Submit
    document.getElementById('evalForm').onsubmit = async (e) => {
        e.preventDefault();
        if(!document.getElementById('selectedSubject').value) return alert("Escolha a Disciplina!");
        
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.improve = formData.getAll('improve');

        try {
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                mode: 'no-cors', // Força o envio mesmo se o CORS do n8n falhar
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            // Com 'no-cors' não conseguimos ler a resposta, então assumimos sucesso se não der erro de rede
            alert("Avaliação Registrada!");
            location.reload();
        } catch (err) {
            alert("Erro de conexão. Verifique se o n8n está Ativo.");
            btn.disabled = false;
            btn.innerText = "Finalizar Avaliação";
        }
    };

    initScanner();
</script>

</body>
</html>
